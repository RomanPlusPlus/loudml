#!/usr/bin/make -f

#export DH_VERBOSE = 1
export PYBUILD_NAME = loudml-influx
# Testing tries to use dependencies that could be absent.
export PYBUILD_DISABLE = test
# Disable build for Python2
export PYBUILD_DISABLE_python2 = 1

%:
	dh $@ --with python3 --buildsystem=pybuild

# Keep bytecode instead of source code
# Because cleaning done by dh_python3 is not configurable, the function
# /usr/share/dh-python/dhpython/fs.py:is_unwanted_file() has to be edited to
# always return False.
_pyver := $(shell python3 --version | cut -d ' ' -f 2 | cut -d '.' -f -2)
_pyvernum := $(shell echo $(_pyver) | sed 's/\.//')
_pydir := debian/loudml-influx/usr/lib/python$(_pyver)/dist-packages
override_dh_install:
	dh_install
	rm -f ${_pydir}/loudml/*.py
	for src in $$(find ${_pydir}/loudml/__pycache__/ -name "*.cpython-$(_pyvernum).pyc"); \
	do \
		dst=$$(basename $$src .cpython-$(_pyvernum).pyc).pyc; \
		cp $$src ${_pydir}/loudml/$$dst; \
	done
	find ${_pydir} -name requires.txt | xargs rm -f

# When trying to detect dependencies on existing Debian packages, dh_python3
# will incorrectly inject a dependency on python3-influxdb that does not exist
# on Debian 9 (although it used to exist on Debian 8).
override_dh_python3:
	dh_python3 --no-guessing-deps
